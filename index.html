<!DOCTYPE html>
<html lang="en">

<head>
    <title>Micro Machines</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0px;
            overflow: hidden;
        }

        #scene {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
    </style>
</head>

<body>
    <div id="scene"></div>

    <script src="lib/three.js"></script>
    <script src="lib/proton/three.proton.min.js"></script>
    <script src="lib/StereoEffect.js"></script>
    <script src="lib/DeviceOrientationControls.js"></script>
    <script src="lib/OrbitControls.js"></script>
    <script src="lib/loaders/OBJLoader.js"></script>
    <script src="lib/loaders/MTLLoader.js"></script>
    <script src="lib/objects/Lensflare.js"></script>
    <script src="src/loader.js"></script>
    <script src="src/billboard.js"></script>
    <script src="src/light.js"></script>
    <script src="src/particles.js"></script>
    <script src="src/car.js"></script>
    <script src="src/orange.js"></script>
    <script src="src/butters.js"></script>
   
    <script>
        var camera, scene, renderer;
        var effect, controls;
        var element, container;

        var clock = new THREE.Clock();

        init();
        animate();

        function init() {
            renderer = new THREE.WebGLRenderer({
                
            });
            renderer.gammaOutput = true
            renderer.shadowMap.enabled = true
            renderer.shadowMap.type = THREE.PCFSoftShadowMap
            renderer.setClearColor(0xa4a4a4, 1)
            element = renderer.domElement;
            container = document.getElementById('scene');
            container.appendChild(element);

            effect = new THREE.StereoEffect(renderer);

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0xaaaaaa, 0.005)
            
            camera = new THREE.PerspectiveCamera(90, 1, 0.001, 700);
            camera.position.set(2, 15, 0);
            scene.add(camera);

            controls = new THREE.OrbitControls(camera, element);
            controls.rotateUp(Math.PI / 4);
            controls.target.set(
                camera.position.x + 0.1,
                camera.position.y,
                camera.position.z
            );
            controls.noZoom = true;
            controls.noPan = true;

            function setOrientationControls(e) {
                if (!e.alpha) {
                    return;
                }

                controls = new THREE.DeviceOrientationControls(camera, true);
                controls.connect();
                controls.update();

                element.addEventListener('click', fullscreen, false);

                window.removeEventListener('deviceorientation', setOrientationControls, true);
            }
            window.addEventListener('deviceorientation', setOrientationControls, true);
            
            createScene();
           
            window.addEventListener('resize', resize, false);
            setTimeout(resize, 1);
        }

        function createScene(){
            lights = new Lights()
            scene.add(lights)

            //Car
            car = new Car()
            car.add(camera);
            scene.add(car)

            //Table
            table = loadObject("../models/table/table.mtl", "../models/table/table.obj", false, true)
            table.scale.set(5, 5, 5)
            table.name = "Table"
            scene.add(table)

            oranges = new THREE.Group()

            for (let i = 0; i < 10; i++) {
                oranges.add(new Orange())
            }
            scene.add(oranges)

            //Butters
            butters = new Butters()
            scene.add(butters)

            //Cheerios
            cheerios = new THREE.Group()

            for (let i = 0; i < 60; i++) {
                const angle = 6 * i;
                const x = 350 * Math.cos(angle * Math.PI / 180)
                const z = 350 * Math.sin(angle * Math.PI / 180)

                const cheerio = loadObject("../models/cheerio/cheerio.mtl", "../models/cheerio/cheerio.obj", true, false)
                cheerio.position.set(x, 1.5, z)
                cheerio.name = "Cheerio_" + i
                cheerio.scale.set(3, 3, 3)
                cheerios.add(cheerio)
            }

            scene.add(cheerios)

            //Particle System
            particles = new ParticleSystem(renderer, scene, camera)
        }

        function resize() {
            var width = container.offsetWidth;
            var height = container.offsetHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
            effect.setSize(width, height);
        }

        function update(dt) {
            resize();
            camera.updateProjectionMatrix();
            controls.update(dt);

            lights.onUpdate(car, camera)

            oranges.traverse(node => {
                if (node instanceof Orange) {
                    node.move()
                }
            })
            butters.onUpdate(dt)
            particles.OnUpdate()

            car.move(1, dt, oranges, butters, cheerios, lights.lamps)
            car.rotate(-1, dt)
        }

        function render(dt) {
            effect.render(scene, camera);
        }

        function animate(t) {
            requestAnimationFrame(animate);

            update(clock.getDelta());
            render(clock.getDelta());
        }

        function fullscreen() {
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.msRequestFullscreen) {
                container.msRequestFullscreen();
            } else if (container.mozRequestFullScreen) {
                container.mozRequestFullScreen();
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
            }
        }
    </script>
</body>

</html>